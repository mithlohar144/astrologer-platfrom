<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet Recharge - Stellarium</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="js/navbar-utils.js"></script>
    <script src="js/config.js"></script>
    <style>
        body { background:#f6f8fb; min-height:100vh; font-family:'Montserrat', sans-serif; }
        
        .wallet-container { max-width: 980px; margin: 40px auto; padding: 0 20px; }
        
        .wallet-card { background:#fff; border:1px solid #eef1f7; border-radius:16px; box-shadow:0 10px 25px rgba(31,45,61,0.06); overflow:hidden; }
        
        .wallet-header { background:#fff; padding: 24px 24px 8px; }
        
        .balance-display { font-size: 36px; font-weight:800; margin: 8px 0; color:#22314a; }
        .muted { color:#6b7b93; }
        
        .wallet-body { padding: 24px; }
        
        .amount-options { display:flex; flex-wrap: wrap; gap:10px; margin:16px 0 12px; }
        
        .amount-btn { padding:10px 16px; border:1px solid #dfe6f3; border-radius: 999px; background:#fff; cursor:pointer; transition:.2s; text-align:center; font-weight:600; color:#324a6d; }
        
        .amount-btn:hover { border-color:#556cd6; background:#f0f3ff; }
        
        .amount-btn.selected { border-color:#556cd6; background:#556cd6; color:#fff; }
        
        .custom-amount { border:1px solid #dfe6f3; border-radius:10px; padding:12px 14px; font-size:16px; width:260px; }
        
        .payment-methods { margin: 18px 0; }
        
        .payment-method { border:1px solid #e6ecf6; border-radius:12px; padding:16px; margin:10px 0; cursor:pointer; transition:.2s; }
        
        .payment-method:hover { border-color:#556cd6; background:#f8f9ff; }
        
        .payment-method.selected { border-color:#556cd6; background:#f8f9ff; }
        
        .recharge-btn { background:#1e7bff; border:none; border-radius:10px; padding:12px 18px; color:#fff; font-weight:600; font-size:16px; }
        .right { text-align:right; }
        
        /* Back button (in topbar) */
        .back-btn { box-shadow: 0 8px 24px rgba(31,45,61,0.12); border: none; border-radius:10px; }
        
        .transaction-history { margin-top: 24px; }
        
        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .transaction-item:last-child {
            border-bottom: none;
        }
        
        .transaction-amount.credit {
            color: #28a745;
        }
        
        .transaction-amount.debit {
            color: #dc3545;
        }

        /* Sidebar + off-canvas (match user-profile) */
        .dashboard-layout { display: flex; gap: 24px; padding: 16px; max-width: 1200px; margin: 0 auto; }
        .sidebar { width: 260px; background:#fff; border:1px solid #eef1f7; border-radius:16px; box-shadow:0 10px 25px rgba(31,45,61,0.06); padding:16px; height: 100%; }
        .sidebar .user-block { display:flex; align-items:center; gap:12px; padding:8px 8px 16px; border-bottom:1px solid #eef1f7; }
        .sidebar .avatar { width:40px; height:40px; border-radius:50%; background:#e9ecfb; display:flex; align-items:center; justify-content:center; font-weight:700; color:#556cd6; }
        .sidebar .menu { list-style:none; padding:0; margin:12px 0 0; }
        .sidebar .menu li a { display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:10px; color:#324a6d; text-decoration:none; }
        .sidebar .menu li a:hover, .sidebar .menu li a.active { background:#eef1f7; }
        .sidebar .menu i { width:18px; text-align:center; color:#556cd6; }
        .dashboard-content { flex:1; background:#fff; border:1px solid #eef1f7; border-radius:16px; padding:16px; box-shadow:0 10px 25px rgba(31,45,61,0.06); }
        .topbar { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
        .menu-btn { border:1px solid #e6ecf6; background:#fff; border-radius:10px; padding:8px 12px; color:#22314a; box-shadow:0 6px 14px rgba(31,45,61,0.06); }
        .sidebar-overlay { position: fixed; inset: 0; background: rgba(17,24,39,0.35); backdrop-filter: blur(1px); opacity: 0; pointer-events: none; transition: opacity .2s ease; z-index: 1040; }
        .sidebar-overlay.show { opacity: 1; pointer-events: auto; }
        @media (max-width: 768px) {
            .dashboard-layout { flex-direction: column; padding: 12px; }
            .sidebar { width: 88%; max-width: 320px; position: fixed; top: 0; left: 0; height: 100vh; transform: translateX(-105%); transition: transform .22s ease; z-index: 1050; border-radius: 0 16px 16px 0; }
            .sidebar.open { transform: translateX(0); }
        }
    </style>
</head>
<body>
    <!-- Preloader -->
    <div class="preloader">
        <div class="loader"></div>
    </div>

    <!-- Off-canvas sidebar + overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <div class="dashboard-layout">
        <aside class="sidebar">
            <div class="user-block">
                <div class="avatar"><span id="avatar-initials">U</span></div>
                <div>
                    <div id="user-name" style="font-weight:700; color:#22314a;">Account</div>
                    <div id="user-email" class="text-muted" style="font-size: 12px;">Loading...</div>
                </div>
            </div>
            <ul class="menu">
                <li><a href="user-profile.html"><i class="fas fa-home"></i> Home</a></li>
                <li><a class="active" href="wallet-recharge.html"><i class="fas fa-wallet"></i> Wallet</a></li>
                <li><a href="session.html"><i class="fas fa-phone"></i> Call/Chat</a></li>
                <li><a href="appointments.html"><i class="fas fa-calendar-alt"></i> Appointments</a></li>
                <!-- <li><a href="reviews.html"><i class="fas fa-star"></i> Reviews</a></li> -->
                <li><a href="#" onclick="startEditProfile && startEditProfile(); return false;"><i class="fas fa-cog"></i> Settings/Profile</a></li>
            </ul>
        </aside>
        <main class="dashboard-content" id="main-content">
            <div class="topbar">
                <div class="d-flex align-items-center gap-2">
                    <button class="menu-btn d-inline-flex align-items-center gap-2 d-md-none" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                        <span>Menu</span>
                    </button>
                    <h1 class="ms-1 ms-md-0 h4 mb-0">Wallet</h1>
                </div>
                <div>
                    <button class="btn btn-light back-btn d-none d-md-inline-flex align-items-center" onclick="goBack()">
                        <i class="fas fa-arrow-left me-2"></i> Back to Home
                    </button>
                </div>
            </div>

            <div class="wallet-container">
                <div class="wallet-card">
            <!-- Wallet Header -->
            <div class="wallet-header">
                <h2 class="mb-1">Wallet</h2>
                <div class="muted">Current Balance</div>
                <div class="balance-display" id="currentBalanceText">₹0.00</div>
            </div>

            <!-- Wallet Body -->
            <div class="wallet-body">
                <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
                    <div>
                        <div class="muted fw-semibold">Add Money</div>
                        <div class="amount-options mt-2">
                            <div class="amount-btn" data-amount="100">₹100</div>
                            <div class="amount-btn" data-amount="200">₹200</div>
                            <div class="amount-btn" data-amount="500">₹500</div>
                            <div class="amount-btn" data-amount="1000">₹1000</div>
                            <div class="amount-btn" data-amount="2000">₹2000</div>
                            <div class="amount-btn" data-amount="5000">₹5000</div>
                        </div>
                        <input type="number" id="customAmount" class="custom-amount" placeholder="Enter amount (₹1 - ₹5000)" min="1" max="5000">
                    </div>
                    <div class="right">
                        <button id="rechargeBtn" class="recharge-btn" onclick="processRecharge()">
                            <i class="fas fa-plus me-2"></i>Add Money
                        </button>
                    </div>
                </div>

                <div class="payment-methods">
                    <div class="payment-method" data-method="razorpay">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-credit-card me-3" style="font-size: 22px; color: #556cd6;"></i>
                            <div>
                                <div class="fw-semibold">Razorpay</div>
                                <small class="text-muted">Card, UPI, Net Banking</small>
                            </div>
                        </div>
                    </div>
                    <div class="payment-method" data-method="mock">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-flask me-3" style="font-size: 22px; color: #28a745;"></i>
                            <div>
                                <div class="fw-semibold">Mock Payment</div>
                                <small class="text-muted">For testing in development</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="transaction-history">
                    <div class="fw-semibold mb-2">Transaction History</div>
                    <div class="table-responsive table-rounded">
                        <table class="table mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Balance After</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody id="transactionTableBody">
                                <!-- Rows injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // API base URL fallback (match user-profile)
        const API_URL = (window.API_CONFIG && window.API_CONFIG.API_URL) ? window.API_CONFIG.API_URL : 'http://localhost:9000/api';

        let selectedAmount = 0;
        let selectedPaymentMethod = 'razorpay';

        // Helpers to render user header
        function getInitials(nameOrEmail) {
            if (!nameOrEmail) return 'U';
            const str = String(nameOrEmail).trim();
            if (str.includes(' ')) {
                const parts = str.split(/\s+/).slice(0, 2);
                return parts.map(p => p[0]).join('').toUpperCase();
            }
            if (str.includes('@')) return str[0].toUpperCase();
            return str.slice(0, 2).toUpperCase();
        }
        function setAvatarInitials(text) {
            const el = document.getElementById('avatar-initials');
            if (el) el.textContent = getInitials(text);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthAndLoadWallet();
            setupEventListeners();

            // Populate sidebar user info from localStorage
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            if (user) {
                const nameEl = document.getElementById('user-name');
                const emailEl = document.getElementById('user-email');
                if (nameEl) nameEl.textContent = user.name || 'User';
                if (emailEl) emailEl.textContent = user.email || '';
                setAvatarInitials(user.name || user.email || 'U');
            }
        });

        function checkAuthAndLoadWallet() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login-working.html';
                return;
            }
            
            loadWalletData();
            hidePreloader();
        }

        function setupEventListeners() {
            // Amount selection
            document.querySelectorAll('.amount-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedAmount = parseInt(this.dataset.amount);
                    document.getElementById('customAmount').value = '';
                });
            });

            // Custom amount input
            document.getElementById('customAmount').addEventListener('input', function() {
                document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('selected'));
                selectedAmount = parseInt(this.value) || 0;
            });

            // Payment method selection
            document.querySelectorAll('.payment-method').forEach(method => {
                method.addEventListener('click', function() {
                    document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedPaymentMethod = this.dataset.method;
                });
            });

            // Set default selections
            document.querySelector('.payment-method[data-method="razorpay"]').classList.add('selected');
        }

        async function loadWalletData() {
            const token = localStorage.getItem('token');
            try {
                // Fetch wallet balance
                const balanceResponse = await fetch(`${API_URL}/wallet/balance`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const balanceData = await balanceResponse.json();
                if (balanceData.success) {
                    document.getElementById('currentBalanceText').textContent = formatINR((balanceData.data && balanceData.data.balance) || 0);
                } else {
                    document.getElementById('currentBalanceText').textContent = formatINR(0);
                }

                // Fetch wallet history
                const historyResponse = await fetch(`${API_URL}/wallet/history`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const historyData = await historyResponse.json();

                if (historyData.success) {
                    const txs = historyData.data && historyData.data.transactions ? historyData.data.transactions : [];
                    renderTransactionHistory(txs);
                } else {
                    throw new Error(historyData.message);
                }
            } catch (error) {
                console.error('Error loading wallet data:', error);
                showToast(error.message || 'Could not load wallet data.', 'error');
            } finally {
                hidePreloader();
            }
        }

        function renderTransactionHistory(transactions) {
            const tbody = document.getElementById('transactionTableBody');
            if (!transactions || transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No transactions yet</td></tr>';
                return;
            }
            const rows = transactions.slice(0, 10).map(tx => {
                const dt = new Date(tx.createdAt);
                const date = dt.toLocaleDateString();
                const amount = `${tx.type === 'credit' ? '+' : '-'}${formatINR(tx.amount || 0)}`;
                const balanceAfter = formatINR(tx.balanceAfter || 0);
                return `
                    <tr>
                        <td>${date}</td>
                        <td class="${tx.type === 'credit' ? 'text-success' : 'text-danger'}">${amount}</td>
                        <td>${balanceAfter}</td>
                        <td>${tx.description || ''}</td>
                    </tr>
                `;
            }).join('');
            tbody.innerHTML = rows;
        }

        function formatINR(value) {
            try { return new Intl.NumberFormat('en-IN', { style:'currency', currency:'INR'}).format(Number(value) || 0); } catch { return `₹${Number(value||0).toFixed(2)}`; }
        }

        async function processRecharge() {
            if (selectedAmount <= 0 || selectedAmount > 5000) {
                showToast('Please select or enter a valid amount (₹1 - ₹5000)', 'error');
                return;
            }

            if (!selectedPaymentMethod) {
                showToast('Please select a payment method', 'error');
                return;
            }

            const rechargeBtn = document.getElementById('rechargeBtn');
            rechargeBtn.disabled = true;
            rechargeBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';

            try {
                if (selectedPaymentMethod === 'mock') {
                    await processMockPayment();
                } else if (selectedPaymentMethod === 'razorpay') {
                    await processRazorpayPayment();
                }
            } catch (error) {
                console.error('Payment error:', error);
                showToast('Payment failed. Please try again.', 'error');
            } finally {
                rechargeBtn.disabled = false;
                rechargeBtn.innerHTML = '<i class="fas fa-plus me-2"></i>Add Money';
            }
        }

        async function processMockPayment() {
            const token = localStorage.getItem('token');
            
            const response = await fetch(`${API_URL}/wallet/topup`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    amount: selectedAmount,
                    paymentMethod: 'mock'
                })
            });

            const data = await response.json();
            
            if (data.success) {
                showToast(`₹${selectedAmount} added to wallet successfully!`, 'success');
                loadWalletData(); // Refresh wallet data
                if (window.loadUserData) { try { window.loadUserData(); } catch (e) { /* ignore */ } }
                resetForm();
            } else {
                throw new Error(data.message);
            }
        }

        async function processRazorpayPayment() {
            const token = localStorage.getItem('token');
            
            // Create Razorpay order
            const orderResponse = await fetch(`${API_URL}/wallet/create-order`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    amount: selectedAmount
                })
            });

            const orderData = await orderResponse.json();
            
            if (!orderData.success) {
                throw new Error(orderData.message);
            }

            // Initialize Razorpay
            const options = {
                key: orderData.data.key,
                amount: orderData.data.amount,
                currency: orderData.data.currency,
                order_id: orderData.data.orderId,
                name: 'Stellarium Astrology',
                description: 'Wallet Recharge',
                image: '/img/logo.png',
                handler: async function(response) {
                    await verifyRazorpayPayment(response, selectedAmount);
                },
                prefill: {
                    name: JSON.parse(localStorage.getItem('user')).name,
                    email: JSON.parse(localStorage.getItem('user')).email,
                    contact: JSON.parse(localStorage.getItem('user')).contact
                },
                theme: {
                    color: '#667eea'
                }
            };

            const rzp = new Razorpay(options);
            rzp.open();
        }

        async function verifyRazorpayPayment(response, amount) {
            const token = localStorage.getItem('token');
            
            const verifyResponse = await fetch(`${API_URL}/wallet/verify-payment`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    razorpay_order_id: response.razorpay_order_id,
                    razorpay_payment_id: response.razorpay_payment_id,
                    razorpay_signature: response.razorpay_signature,
                    amount: amount
                })
            });

            const verifyData = await verifyResponse.json();
            
            if (verifyData.success) {
                showToast(`₹${amount} added to wallet successfully!`, 'success');
                loadWalletData(); // Refresh wallet data
                if (window.loadUserData) { try { window.loadUserData(); } catch (e) { /* ignore */ } }
                resetForm();
            } else {
                throw new Error(verifyData.message);
            }
        }

        function resetForm() {
            selectedAmount = 0;
            document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById('customAmount').value = '';
        }

        function hidePreloader() {
            const preloader = document.querySelector('.preloader');
            if (preloader) {
                preloader.style.display = 'none';
            }
        }

        function showToast(message, type = 'info') {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;

            // Add to page
            let toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                document.body.appendChild(toastContainer);
            }
            
            toastContainer.appendChild(toast);
            
            // Show toast
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            // Remove after hiding
            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }

        // Sidebar controls
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        function openSidebar() {
            if (!sidebar) return;
            sidebar.classList.add('open');
            if (overlay) overlay.classList.add('show');
            document.body.style.overflow = 'hidden';
        }
        function closeSidebar() {
            if (!sidebar) return;
            sidebar.classList.remove('open');
            if (overlay) overlay.classList.remove('show');
            document.body.style.overflow = '';
        }
        function toggleSidebar() {
            if (!sidebar) return;
            if (sidebar.classList.contains('open')) closeSidebar(); else openSidebar();
        }
        if (overlay) overlay.addEventListener('click', closeSidebar);
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeSidebar(); });

        // Back navigation
        function goBack() {
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
